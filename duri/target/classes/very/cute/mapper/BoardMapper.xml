<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="very.cute.mapper.BoardMapper">
  <sql id="search">
  <if test="type != null">
  <!-- 제목 검색 -->
  <if test="type == 'T'.toString()">
  where title like concat('%',#{keyword},'%')
  </if>
  
  <!-- 내용 검색 -->
  <if test="type == 'C'.toString()">
  where content like concat('%',#{keyword},'%')
  </if>
  
  <!-- 글쓴이 검색 -->
  <if test="type == 'W'.toString()">
  where writer like concat('%',#{keyword},'%')
  </if>
  
  <!-- 제목+내용 검색 -->
  <if test="type == 'TC'.toString()">
  where (title like concat('%',#{keyword},'%') or content like concat('%',#{keyword},'%'))
  </if>
  
  <!-- 통합 검색 -->
  <if test="type == 'TCW'.toString()">
  where (title like concat('%',#{keyword},'%') or content like concat('%',#{keyword},'%') or writer like concat('%',#{keyword},'%'))
  </if>
  </if>
  </sql>
<insert id="create">
		<selectKey keyProperty="bno" order="BEFORE" resultType="int">
			select max(bno)+1 bno from t_board
		</selectKey>

		insert into t_board (bno, title, content, writer)
		values (#{bno},#{title},#{content},#{writer})
	</insert>

	<select id="read" resultType="very.cute.domain.BoardVO">
		select * from t_board where bno=#{bno}
	</select>
  
  <update id="update">
  update t_board set title=#{title}, content =#{content}, regdate = now() where bno = #{bno}
  </update>
  
  <delete id="delete">
  delete from t_board where bno = #{bno}
  </delete>
  
  <select id="listAll" resultType="very.cute.domain.BoardVO">
  <![CDATA[
  select * from t_board where bno > 0 order by bno desc
  ]]>
  </select>
  
  <select id="listPage" resultType="very.cute.domain.BoardVO">
  	select bno, title, content, writer, regdate, viewcnt 
  	from (
  	select @rownum:=@rownum+1 as rownum, b.*
  	 from (select @rownum:=0) as tmp, t_board as b
  	<include refid="search"></include>
  	order by bno desc
  	) as boardList
  	
  	<![CDATA[
  	where rownum > (#{pageNum}-1)*#{amount}
  	and rownum <= #{pageNum}*#{amount}
  	]]>
  </select>
  
  <select id="getTotalCount" resultType="int">
  select count(*) from t_board
  <include refid="search"></include>
  </select>
  
  <update id="viewCount" parameterType="int">
  update t_board set viewcnt = viewcnt+1 where bno=#{bno}
  </update>
  
  </mapper>